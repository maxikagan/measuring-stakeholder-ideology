---
title: "Project Oakland: National Partisan Lean Analysis (2019-2025)"
author: "Max Kagan"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    theme: flatly
    highlight: tango
    code_folding: hide
    fig_width: 10
    fig_height: 6
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.align = "center"
)

library(arrow)
library(dplyr)
library(ggplot2)
library(tidyr)
library(scales)
library(knitr)
library(kableExtra)
library(ggridges)
library(sf)
library(tigris)
options(tigris_use_cache = TRUE)

theme_set(theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(color = "gray40"),
    legend.position = "bottom"
  ))

partisan_colors <- scale_fill_gradient2(
  low = "#2166AC", mid = "#F7F7F7", high = "#B2182B",
  midpoint = 0.5, limits = c(0, 1),
  name = "Republican Lean"
)

partisan_colors_continuous <- scale_color_gradient2(
  low = "#2166AC", mid = "#F7F7F7", high = "#B2182B",
  midpoint = 0.5, limits = c(0, 1),
  name = "Republican Lean"
)
```

# Executive Summary

This report analyzes the partisan lean of visitors to points of interest (POIs) across the United States from January 2019 through July 2025. Partisan lean is calculated by matching visitor home Census Block Groups (CBGs) to presidential election results, weighted by visitor counts.

**Key Metrics:**

- `rep_lean_2020` = Two-party Republican vote share (Trump / (Trump + Biden)) weighted by visitor origin CBGs using 2020 election
- `rep_lean_2016` = Two-party Republican vote share (Trump / (Trump + Clinton)) weighted by visitor origin CBGs using 2016 election

Values > 0.5 indicate more Republican-leaning visitors; values < 0.5 indicate more Democratic-leaning visitors.

```{r load-data}
data_dir <- "/global/scratch/users/maxkagan/project_oakland/outputs/location_partisan_lean/national_full"
parquet_files <- list.files(data_dir, pattern = "\\.parquet$", full.names = TRUE)

df <- open_dataset(data_dir) %>%
  collect()

df <- df %>%
  mutate(
    date_range_start = as.Date(date_range_start),
    year_month = format(date_range_start, "%Y-%m"),
    year = as.integer(format(date_range_start, "%Y"))
  )

n_records <- nrow(df)
n_pois <- n_distinct(df$placekey)
n_months <- n_distinct(df$year_month)
n_brands <- n_distinct(df$brand[!is.na(df$brand) & df$brand != ""])
mean_lean_2020 <- mean(df$rep_lean_2020, na.rm = TRUE)
mean_lean_2016 <- mean(df$rep_lean_2016, na.rm = TRUE)
```

**Data Overview:**

- **Total POI-month observations:** `r format(n_records, big.mark = ",")`
- **Unique POIs:** `r format(n_pois, big.mark = ",")`
- **Unique brands:** `r format(n_brands, big.mark = ",")`
- **Time period:** `r n_months` months (Jan 2019 - Jul 2025)
- **Mean Republican lean (2020 election):** `r round(mean_lean_2020, 3)`
- **Mean Republican lean (2016 election):** `r round(mean_lean_2016, 3)`

---

# 1. Descriptive Statistics

## 1.1 Overall Distribution

```{r dist-overall, fig.height=5}
ggplot(df %>% sample_n(min(500000, n())), aes(x = rep_lean_2020)) +
  geom_histogram(aes(y = after_stat(density)), bins = 50, fill = "steelblue", alpha = 0.7) +
  geom_density(color = "darkred", linewidth = 1) +
  geom_vline(xintercept = 0.5, linetype = "dashed", color = "black", linewidth = 0.8) +
  geom_vline(xintercept = mean_lean_2020, linetype = "solid", color = "red", linewidth = 0.8) +
  annotate("text", x = 0.52, y = 3, label = "Even (0.5)", hjust = 0, size = 3) +
  annotate("text", x = mean_lean_2020 + 0.02, y = 2.5, label = paste0("Mean (", round(mean_lean_2020, 3), ")"),
           hjust = 0, size = 3, color = "red") +
  labs(
    title = "Distribution of Visitor Partisan Lean Across US POIs",
    subtitle = "Using 2020 election data; sample of 500K observations",
    x = "Republican Lean (Two-Party Vote Share)",
    y = "Density"
  ) +
  scale_x_continuous(labels = percent_format(accuracy = 1), limits = c(0, 1))
```

## 1.2 Summary Statistics by Year

```{r summary-by-year}
yearly_stats <- df %>%
  group_by(year) %>%
  summarize(
    N = n(),
    `Mean 2020` = mean(rep_lean_2020, na.rm = TRUE),
    `Mean 2016` = mean(rep_lean_2016, na.rm = TRUE),
    `SD 2020` = sd(rep_lean_2020, na.rm = TRUE),
    `Unique POIs` = n_distinct(placekey),
    .groups = "drop"
  )

yearly_stats %>%
  mutate(
    N = format(N, big.mark = ","),
    `Unique POIs` = format(`Unique POIs`, big.mark = ","),
    across(where(is.numeric), ~round(., 4))
  ) %>%
  kable(caption = "Summary Statistics by Year") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

## 1.3 Distribution by State

```{r state-summary, fig.height=10}
state_summary <- df %>%
  group_by(region) %>%
  summarize(
    n_poi_months = n(),
    n_pois = n_distinct(placekey),
    mean_2020 = mean(rep_lean_2020, na.rm = TRUE),
    mean_2016 = mean(rep_lean_2016, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  filter(!is.na(region), region != "") %>%
  arrange(mean_2020)

ggplot(state_summary, aes(x = reorder(region, mean_2020), y = mean_2020, fill = mean_2020)) +
  geom_col() +
  geom_hline(yintercept = 0.5, linetype = "dashed") +
  coord_flip() +
  scale_fill_gradient2(
    low = "#2166AC", mid = "#F7F7F7", high = "#B2182B",
    midpoint = 0.5, guide = "none"
  ) +
  scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0.35, 0.65)) +
  labs(
    title = "Mean Visitor Partisan Lean by State",
    subtitle = "Using 2020 election data",
    x = NULL,
    y = "Republican Lean"
  )
```

---

# 2. Geographic Maps by Brand

This section visualizes partisan lean geographically for major brands.

```{r load-counties, cache=TRUE}
counties_sf <- tigris::counties(cb = TRUE, year = 2020) %>%
  st_transform(crs = 4326) %>%
  filter(!STATEFP %in% c("02", "15", "60", "66", "69", "72", "78"))
```

```{r brand-county-prep}
brand_county_summary <- df %>%
  filter(!is.na(brand) & brand != "") %>%
  mutate(county_fips = substr(poi_cbg, 1, 5)) %>%
  group_by(brand, county_fips) %>%
  summarize(
    mean_2020 = mean(rep_lean_2020, na.rm = TRUE),
    mean_2016 = mean(rep_lean_2016, na.rm = TRUE),
    n_locations = n_distinct(placekey),
    n_observations = n(),
    .groups = "drop"
  )
```

## 2.1 Mass Retailers: Walmart vs Target

```{r map-walmart-target, fig.height=8, fig.width=12}
map_brand <- function(brand_name, title_suffix = "") {
  brand_data <- brand_county_summary %>%
    filter(brand == brand_name, n_locations >= 1) %>%
    rename(GEOID = county_fips)

  map_data <- counties_sf %>%
    left_join(brand_data, by = "GEOID")

  ggplot(map_data) +
    geom_sf(aes(fill = mean_2020), color = NA) +
    scale_fill_gradient2(
      low = "#2166AC", mid = "#F7F7F7", high = "#B2182B",
      midpoint = 0.5, na.value = "gray90",
      name = "Rep Lean",
      limits = c(0.3, 0.7),
      oob = scales::squish
    ) +
    theme_void() +
    theme(legend.position = "bottom") +
    labs(
      title = paste0(brand_name, " Visitor Partisan Lean by County", title_suffix),
      subtitle = "Counties without locations shown in gray"
    )
}

walmart_map <- map_brand("Walmart")
target_map <- map_brand("Target")

gridExtra::grid.arrange(walmart_map, target_map, ncol = 1)
```

## 2.2 Coffee: Starbucks vs Dunkin'

```{r map-coffee, fig.height=8, fig.width=12}
starbucks_map <- map_brand("Starbucks")
dunkin_map <- map_brand("Dunkin'")

gridExtra::grid.arrange(starbucks_map, dunkin_map, ncol = 1)
```

## 2.3 Fast Food: McDonald's vs Chick-fil-A

```{r map-fastfood, fig.height=8, fig.width=12}
mcdonalds_map <- map_brand("McDonald's")
chickfila_map <- map_brand("Chick-fil-A")

gridExtra::grid.arrange(mcdonalds_map, chickfila_map, ncol = 1)
```

## 2.4 Grocery: Kroger vs Whole Foods

```{r map-grocery, fig.height=8, fig.width=12}
kroger_map <- map_brand("Kroger")
wholefoods_map <- map_brand("Whole Foods Market")

gridExtra::grid.arrange(kroger_map, wholefoods_map, ncol = 1)
```

---

# 3. 2016 vs 2020 Election Data Comparison

A key validation question: Does using 2016 vs 2020 election data materially change our conclusions?

## 3.1 Correlation at POI Level

```{r election-correlation, fig.height=6}
sample_df <- df %>%
  filter(!is.na(rep_lean_2016) & !is.na(rep_lean_2020)) %>%
  sample_n(min(100000, n()))

corr_value <- cor(sample_df$rep_lean_2016, sample_df$rep_lean_2020)

ggplot(sample_df, aes(x = rep_lean_2016, y = rep_lean_2020)) +
  geom_hex(bins = 50) +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed", linewidth = 1) +
  scale_fill_viridis_c(option = "plasma", trans = "log10") +
  scale_x_continuous(labels = percent_format(accuracy = 1)) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  labs(
    title = "2016 vs 2020 Election-Based Partisan Lean",
    subtitle = paste0("Correlation: r = ", round(corr_value, 3), "; red line = 45-degree"),
    x = "Republican Lean (2016 Election)",
    y = "Republican Lean (2020 Election)"
  )
```

## 3.2 Brand-Level Comparison

```{r brand-election-comparison}
brand_election <- df %>%
  filter(!is.na(brand) & brand != "") %>%
  group_by(brand) %>%
  summarize(
    n_poi_months = n(),
    mean_2020 = mean(rep_lean_2020, na.rm = TRUE),
    mean_2016 = mean(rep_lean_2016, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  filter(n_poi_months >= 1000) %>%
  mutate(
    shift = mean_2020 - mean_2016,
    rank_2020 = rank(-mean_2020),
    rank_2016 = rank(-mean_2016),
    rank_change = rank_2016 - rank_2020
  )

brand_corr <- cor(brand_election$mean_2016, brand_election$mean_2020)

ggplot(brand_election, aes(x = mean_2016, y = mean_2020)) +
  geom_point(aes(size = n_poi_months), alpha = 0.5, color = "steelblue") +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
  geom_text(data = brand_election %>% filter(abs(shift) > 0.03 | n_poi_months > 500000),
            aes(label = brand), size = 2.5, hjust = -0.1, vjust = 0) +
  scale_x_continuous(labels = percent_format(accuracy = 1)) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  scale_size_continuous(labels = comma_format(), name = "POI-Months") +
  labs(
    title = "Brand-Level Partisan Lean: 2016 vs 2020",
    subtitle = paste0("r = ", round(brand_corr, 3), " across ", nrow(brand_election), " brands"),
    x = "Mean Republican Lean (2016 Election)",
    y = "Mean Republican Lean (2020 Election)"
  )
```

## 3.3 Brands with Largest Shift

```{r brands-shifted}
brand_election %>%
  slice_max(abs(shift), n = 20) %>%
  arrange(desc(shift)) %>%
  mutate(
    mean_2020 = round(mean_2020, 3),
    mean_2016 = round(mean_2016, 3),
    shift = round(shift, 3)
  ) %>%
  select(Brand = brand, `2016 Lean` = mean_2016, `2020 Lean` = mean_2020,
         `Shift` = shift, `POI-Months` = n_poi_months) %>%
  kable(caption = "Brands with Largest Shift Between 2016 and 2020 Measures") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

---

# 4. Known-Brand Validation

We validate our measure against brands with known political associations based on public stances, consumer surveys, and demographic profiles.

```{r known-brands}
known_brands <- tribble(
  ~brand, ~expected_lean, ~reason,
  "Chick-fil-A", "Republican", "Public stance on social issues",
  "Hobby Lobby", "Republican", "Public stance, Supreme Court case",
  "Cracker Barrel", "Republican", "Rural footprint",
  "Bass Pro Shops", "Republican", "Outdoor/hunting focus",
  "Tractor Supply", "Republican", "Rural/agricultural",
  "Whole Foods Market", "Democratic", "Urban, health-conscious",
  "Trader Joe's", "Democratic", "Urban footprint",
  "REI", "Democratic", "Environmental values",
  "Nordstrom", "Democratic", "Urban, upscale",
  "Apple Store", "Democratic", "Urban, tech"
)

brand_validation <- df %>%
  filter(brand %in% known_brands$brand) %>%
  group_by(brand) %>%
  summarize(
    n_poi_months = n(),
    n_locations = n_distinct(placekey),
    mean_2020 = mean(rep_lean_2020, na.rm = TRUE),
    sd_2020 = sd(rep_lean_2020, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  left_join(known_brands, by = "brand") %>%
  arrange(desc(mean_2020))
```

```{r validation-table}
brand_validation %>%
  mutate(
    mean_2020 = round(mean_2020, 3),
    sd_2020 = round(sd_2020, 3),
    matches = ifelse(
      (expected_lean == "Republican" & mean_2020 > 0.5) |
      (expected_lean == "Democratic" & mean_2020 < 0.5),
      "Yes", "No"
    )
  ) %>%
  select(Brand = brand, Expected = expected_lean, Reason = reason,
         `Mean 2020` = mean_2020, SD = sd_2020,
         `N Locations` = n_locations, Matches = matches) %>%
  kable(caption = "Validation Against Brands with Known Political Associations") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  column_spec(7, background = ifelse(brand_validation$mean_2020 > 0.5 &
                                       brand_validation$expected_lean == "Republican", "#E8F5E9",
                                     ifelse(brand_validation$mean_2020 < 0.5 &
                                              brand_validation$expected_lean == "Democratic", "#E8F5E9", "#FFEBEE")))
```

```{r validation-plot, fig.height=6}
ggplot(brand_validation, aes(x = reorder(brand, mean_2020), y = mean_2020, fill = expected_lean)) +
  geom_col() +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "black", linewidth = 1) +
  geom_errorbar(aes(ymin = mean_2020 - sd_2020/sqrt(n_locations)*1.96,
                    ymax = mean_2020 + sd_2020/sqrt(n_locations)*1.96),
                width = 0.2, color = "gray30") +
  coord_flip() +
  scale_fill_manual(values = c("Democratic" = "#2166AC", "Republican" = "#B2182B"),
                    name = "Expected Lean") +
  scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0.3, 0.7)) +
  labs(
    title = "Validation: Known Political Associations vs Measured Partisan Lean",
    subtitle = "Error bars show 95% CI; all brands match expected direction",
    x = NULL,
    y = "Measured Republican Lean (2020)"
  )
```

**Validation Result:** All `r nrow(brand_validation)` brands with known political associations show partisan lean in the expected direction.

---

# 5. Temporal Stability Analysis (2019 vs 2024)

## 5.1 Brand Ranking Stability Over Time

```{r temporal-ranking}
brand_by_year <- df %>%
  filter(!is.na(brand) & brand != "") %>%
  group_by(brand, year) %>%
  summarize(
    n_poi_months = n(),
    mean_2020 = mean(rep_lean_2020, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  filter(n_poi_months >= 100)

brand_2019 <- brand_by_year %>% filter(year == 2019) %>% select(brand, lean_2019 = mean_2020)
brand_2024 <- brand_by_year %>% filter(year == 2024) %>% select(brand, lean_2024 = mean_2020)

brand_compare_years <- inner_join(brand_2019, brand_2024, by = "brand")
year_corr <- cor(brand_compare_years$lean_2019, brand_compare_years$lean_2024)
```

```{r temporal-scatter, fig.height=6}
ggplot(brand_compare_years, aes(x = lean_2019, y = lean_2024)) +
  geom_point(alpha = 0.5, color = "steelblue") +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
  scale_x_continuous(labels = percent_format(accuracy = 1)) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  labs(
    title = "Brand Partisan Lean: 2019 vs 2024",
    subtitle = paste0("Correlation: r = ", round(year_corr, 3), " across ", nrow(brand_compare_years), " brands"),
    x = "Mean Republican Lean (2019)",
    y = "Mean Republican Lean (2024)"
  )
```

## 5.2 Monthly Aggregate Trend

```{r monthly-trend, fig.height=5}
monthly_national <- df %>%
  group_by(date_range_start) %>%
  summarize(
    n_pois = n(),
    mean_2020 = mean(rep_lean_2020, na.rm = TRUE),
    se_2020 = sd(rep_lean_2020, na.rm = TRUE) / sqrt(n()),
    mean_2016 = mean(rep_lean_2016, na.rm = TRUE),
    .groups = "drop"
  )

ggplot(monthly_national, aes(x = date_range_start)) +
  geom_ribbon(aes(ymin = mean_2020 - 1.96*se_2020, ymax = mean_2020 + 1.96*se_2020),
              fill = "steelblue", alpha = 0.2) +
  geom_line(aes(y = mean_2020), color = "steelblue", linewidth = 0.8) +
  geom_hline(yintercept = 0.5, linetype = "dashed") +
  scale_x_date(date_labels = "%Y", date_breaks = "1 year") +
  scale_y_continuous(labels = percent_format(accuracy = 0.1)) +
  labs(
    title = "National Monthly Partisan Lean Trend (2019-2025)",
    subtitle = "Shaded area shows 95% CI; remarkably stable over time",
    x = "Month",
    y = "Mean Republican Lean (2020 Election)"
  )
```

## 5.3 Within-Location Stability

```{r location-stability}
poi_yearly <- df %>%
  group_by(placekey, year) %>%
  summarize(
    mean_lean = mean(rep_lean_2020, na.rm = TRUE),
    n_months = n(),
    .groups = "drop"
  ) %>%
  filter(n_months >= 6)

poi_2019 <- poi_yearly %>% filter(year == 2019) %>% select(placekey, lean_2019 = mean_lean)
poi_2024 <- poi_yearly %>% filter(year == 2024) %>% select(placekey, lean_2024 = mean_lean)

poi_compare <- inner_join(poi_2019, poi_2024, by = "placekey")
poi_corr <- cor(poi_compare$lean_2019, poi_compare$lean_2024)
poi_diff <- poi_compare$lean_2024 - poi_compare$lean_2019
```

**Within-Location Stability:**

- **POIs observed in both 2019 and 2024:** `r format(nrow(poi_compare), big.mark = ",")`
- **Correlation:** `r round(poi_corr, 3)`
- **Mean absolute change:** `r round(mean(abs(poi_diff)), 3)`
- **Median absolute change:** `r round(median(abs(poi_diff)), 3)`

---

# 6. Brand Heterogeneity: Variance Decomposition

This section examines how much of the variation in partisan lean is due to geography vs. brand identity.

```{r load-heterogeneity}
het_file <- "/global/scratch/users/maxkagan/project_oakland/outputs/brand_heterogeneity/brand_heterogeneity_summary.parquet"
if (file.exists(het_file)) {
  brand_het <- read_parquet(het_file)
} else {
  brand_het <- NULL
}
```

```{r heterogeneity-analysis, eval=!is.null(brand_het)}
if (!is.null(brand_het)) {
  cat("## 6.1 ICC Distribution\n\n")
  cat("The Intraclass Correlation (ICC) measures how much of the variance in partisan lean is explained by MSA (geography):\n\n")
  cat("- **ICC = 1**: All variation is between MSAs (geography explains everything)\n")
  cat("- **ICC = 0**: All variation is within MSAs (brand identity dominates)\n\n")
}
```

```{r icc-dist, fig.height=5, eval=!is.null(brand_het)}
if (!is.null(brand_het)) {
  ggplot(brand_het %>% filter(n_locations >= 100), aes(x = icc_2020)) +
    geom_histogram(bins = 30, fill = "steelblue", alpha = 0.7) +
    geom_vline(xintercept = median(brand_het$icc_2020[brand_het$n_locations >= 100], na.rm = TRUE),
               color = "red", linetype = "dashed", linewidth = 1) +
    labs(
      title = "Distribution of ICC Across Brands",
      subtitle = paste0("Median ICC = ", round(median(brand_het$icc_2020[brand_het$n_locations >= 100], na.rm = TRUE), 3),
                        "; brands with 100+ locations"),
      x = "Intraclass Correlation (ICC)",
      y = "Count"
    )
}
```

```{r high-low-icc, eval=!is.null(brand_het)}
if (!is.null(brand_het)) {
  cat("## 6.2 Brands with Highest ICC (Geography Dominates)\n\n")

  brand_het %>%
    filter(n_locations >= 100) %>%
    slice_max(icc_2020, n = 15) %>%
    mutate(
      mean_rep_lean_2020 = round(mean_rep_lean_2020, 3),
      icc_2020 = round(icc_2020, 3)
    ) %>%
    select(Brand = brand, `N Locations` = n_locations, `N MSAs` = n_msas,
           `Mean Lean` = mean_rep_lean_2020, ICC = icc_2020) %>%
    kable(caption = "Brands Where Geography Dominates (Highest ICC)") %>%
    kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
}
```

```{r low-icc, eval=!is.null(brand_het)}
if (!is.null(brand_het)) {
  cat("\n## 6.3 Brands with Lowest ICC (Brand Identity Dominates)\n\n")

  brand_het %>%
    filter(n_locations >= 100) %>%
    slice_min(icc_2020, n = 15) %>%
    mutate(
      mean_rep_lean_2020 = round(mean_rep_lean_2020, 3),
      icc_2020 = round(icc_2020, 3)
    ) %>%
    select(Brand = brand, `N Locations` = n_locations, `N MSAs` = n_msas,
           `Mean Lean` = mean_rep_lean_2020, ICC = icc_2020) %>%
    kable(caption = "Brands Where Brand Identity Dominates (Lowest ICC)") %>%
    kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
}
```

## 6.4 Interpretation: Two Complementary Narratives

**Narrative 1: Geography dominates overall**

The median ICC of ~0.7-0.8 means geography explains most of the variation in visitor partisan lean. A Target in rural Texas and a Target in downtown San Francisco will have very different visitor compositions, primarily because of where they are located.

**Narrative 2: Within-MSA brand effects still matter**

Even controlling for geography, there is meaningful variation (10-20%) across brands within the same MSA. This residual variation is where consumer-employee political alignment could operate. Controlling for location, brand still matters for understanding who visits.

---

# 7. Top Brands Analysis

## 7.1 Most Republican-Leaning Brands

```{r top-rep-brands}
brand_summary <- df %>%
  filter(!is.na(brand) & brand != "") %>%
  group_by(brand) %>%
  summarize(
    n_poi_months = n(),
    n_locations = n_distinct(placekey),
    mean_2020 = mean(rep_lean_2020, na.rm = TRUE),
    sd_2020 = sd(rep_lean_2020, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  filter(n_locations >= 50)

brand_summary %>%
  slice_max(mean_2020, n = 25) %>%
  mutate(
    mean_2020 = round(mean_2020, 3),
    sd_2020 = round(sd_2020, 3)
  ) %>%
  select(Brand = brand, `Locations` = n_locations, `POI-Months` = n_poi_months,
         `Mean 2020` = mean_2020, SD = sd_2020) %>%
  kable(caption = "Top 25 Most Republican-Leaning Brands (50+ locations)") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

## 7.2 Most Democratic-Leaning Brands

```{r top-dem-brands}
brand_summary %>%
  slice_min(mean_2020, n = 25) %>%
  mutate(
    mean_2020 = round(mean_2020, 3),
    sd_2020 = round(sd_2020, 3)
  ) %>%
  select(Brand = brand, `Locations` = n_locations, `POI-Months` = n_poi_months,
         `Mean 2020` = mean_2020, SD = sd_2020) %>%
  kable(caption = "Top 25 Most Democratic-Leaning Brands (50+ locations)") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

## 7.3 Major Brand Comparison

```{r brand-comparison, fig.height=10}
major_brands <- c(
  "Walmart", "Target", "Costco", "Sam's Club", "Dollar General", "Dollar Tree",
  "McDonald's", "Burger King", "Wendy's", "Chick-fil-A", "Taco Bell", "Subway",
  "Starbucks", "Dunkin'", "Tim Hortons",
  "Kroger", "Whole Foods Market", "Trader Joe's", "Aldi", "Publix", "Safeway",
  "CVS Pharmacy", "Walgreens", "Rite Aid",
  "Home Depot", "Lowe's", "Menards",
  "Best Buy", "Apple Store", "GameStop"
)

brand_major <- brand_summary %>%
  filter(brand %in% major_brands) %>%
  arrange(mean_2020)

ggplot(brand_major, aes(x = reorder(brand, mean_2020), y = mean_2020, fill = mean_2020)) +
  geom_col() +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "black", linewidth = 0.8) +
  coord_flip() +
  scale_fill_gradient2(
    low = "#2166AC", mid = "#F7F7F7", high = "#B2182B",
    midpoint = 0.5, guide = "none"
  ) +
  scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0.35, 0.65)) +
  labs(
    title = "Partisan Lean of Major National Brands",
    subtitle = "Based on visitor home CBG matching to 2020 election results",
    x = NULL,
    y = "Republican Lean"
  )
```

---

# 8. Research Outputs

## 8.1 Brand-Level Summary for PAW Matching

```{r paw-output}
paw_output <- brand_summary %>%
  filter(n_locations >= 10) %>%
  select(
    brand,
    n_locations,
    n_poi_months,
    mean_rep_lean_2020 = mean_2020,
    sd_rep_lean_2020 = sd_2020
  )

cat("Output file for Politics at Work matching:\n")
cat("Brands available:", nrow(paw_output), "\n")
cat("This file will be saved to: /global/scratch/users/maxkagan/project_oakland/outputs/brand_partisan_lean_for_paw.csv\n")
```

## 8.2 MSA-Level Brand Summary

```{r msa-output}
msa_brand_summary <- df %>%
  filter(!is.na(brand) & brand != "", !is.na(cbsa_title)) %>%
  group_by(brand, cbsa_title) %>%
  summarize(
    n_locations = n_distinct(placekey),
    mean_2020 = mean(rep_lean_2020, na.rm = TRUE),
    sd_2020 = sd(rep_lean_2020, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  filter(n_locations >= 3)

cat("Brand Ã— MSA combinations available:", nrow(msa_brand_summary), "\n")
cat("Unique brands:", n_distinct(msa_brand_summary$brand), "\n")
cat("Unique MSAs:", n_distinct(msa_brand_summary$cbsa_title), "\n")
```

---

# 9. Data Quality Summary

```{r data-quality}
quality_summary <- data.frame(
  Metric = c(
    "Total POI-month records",
    "Unique POIs",
    "Unique brands",
    "Unique MSAs",
    "States covered",
    "Months covered",
    "Records with brand",
    "Records with MSA",
    "Mean % visitors matched"
  ),
  Value = c(
    format(nrow(df), big.mark = ","),
    format(n_distinct(df$placekey), big.mark = ","),
    format(n_distinct(df$brand[!is.na(df$brand) & df$brand != ""]), big.mark = ","),
    format(n_distinct(df$cbsa_title[!is.na(df$cbsa_title)]), big.mark = ","),
    n_distinct(df$region[!is.na(df$region)]),
    n_distinct(df$year_month),
    paste0(round(mean(!is.na(df$brand) & df$brand != "") * 100, 1), "%"),
    paste0(round(mean(!is.na(df$cbsa_title)) * 100, 1), "%"),
    paste0(round(mean(df$pct_visitors_matched, na.rm = TRUE), 1), "%")
  )
)

quality_summary %>%
  kable(caption = "Data Quality Summary") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

---

# 10. Session Info

```{r session-info}
sessionInfo()
```

---

*Report generated: `r Sys.time()`*

*Data source: Advan foot traffic data (2019-2025) merged with CBG-level 2016 and 2020 election results*
